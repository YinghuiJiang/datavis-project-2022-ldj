<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>LDJ</title>

    <link rel="stylesheet" href="style.css">

    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3-legend/1.1.0/d3-legend.js"></script>
    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="../script/legend.js"></script>
    <script src="d3.v4.min.js"></script>
    <script type="module" src="../script/mainVisual.js"></script>
</head>

<body>
    <nav class="navbar background">
        <ul class="nav-list">
            <div class="logo">
                <a href="index.html">LDJ</a>
            </div>
            <li><a href="#goal">Goal</a></li>
            <li><a href="#core-Visualization">Core Visualization</a></li>
            <li><a href="#additional-Visualization">Additional Visualization</a></li>
        </ul>

        <!---
        <div class="rightNav">
            <input type="text" name="search" id="search">
            <button class="btn btn-sm">Search</button>
        </div>
        --->
    </nav>

    <section class="firstsection" id="goal">
        <div class="box-main">
            <div class="firstHalf">
                <h1 class="text-big">
                    Goal
                </h1>
                <br>
                <p class="text-small">
                    The goal of this project is to aggregate certain COVID-19 information in the US into easily
                    understandable visualizations that demonstrate trends and insights.
                    Through exploring our visualizations, the users will directly see the progress of the pandemic in
                    each state and how they compare to each other.
                    Moreover, we also aim to create some visualizations that show the effectiveness of COVID protection
                    measures including vaccination.
                </p>
            </div>
        </div>
    </section>

    <section class="secondsection" id="core-Visualization">
        <div class="box-main">
            <div class="secondhalf">
                <h1 class="text-big">
                    Core Visualization

                    <br><br>
                    <p>
                        <button id="deathButton" onclick="deathClick()">Show Deaths</button>
                        <button id="vaccButton" onclick="vaccClick()">Show Vaccination</button>
                </h1>
                </p>
                <svg id="usamap"></svg>
                <div id="main_visual_div">
                    <div id="main_left_graph" class="left_graph">
                        <svg id="deaths-line"></svg>
                    </div>
                    <div id="main_right_graph" class="right_graph">
                        <svg id="vacc-line"></svg>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="thirdsection" id="additional-Visualization">
        <h1 class="text-big" id="additional-Visualization">
            Additional Visual
        </h1>
        <br><br><br><br><br>
        <div class="box-main">
            <div class="secondhalf">
                <div id="vaccination_visual">
                    <div id="vaccination_left_graph" class="left_graph">
                        <p class="graph_title">
                            Weekly Death By Vaccination Status<br></p>
                        <svg id="vaccination_line"></svg>
                    </div>
                    <div id="vaccination_right_graph" class="right_graph">
                        <p class="graph_title">
                            Percentage of Death By Vaccination Status<br></p>
                        <svg id="vaccination_bar"></svg>
                    </div>
                    <script src="../script/vaccinationVisual.js"></script>
                    <br><br>
                </div>
            </div>
        </div>
        <div id= "chart"></div>
        <script src="data_ranking.js"></script>
        <script src="d3.js"></script>
        <script>
            console.log(dataOri);
            const width = 1200, height = 600, margin = { top: 20, bottom: 0, left: 110, right: 100 };
            const chartWidth = width - (margin.left + margin.right), chartHeight = height - (margin.top + margin.bottom);
            const data = [];
            const count = 10;
            const duration = 500;
            const barPadding = 20;
            const barHeight = (chartHeight - (barPadding * count)) / count;
            const getDate = () => dataOri[0][dateIndex];
            let dateIndex = 0;
            let date = getDate();
            let dataSlice = [];
            let chart = null, scale = null, axis = null, svg = null, dateTitle = null;
          
            // create SVG
            const createSvg = () => svg = d3.select('#chart').append('svg').attr('width', width).attr('height', height);
          
            // formatting
            const formatData = () => {
              dataOri[0].forEach((date, index) => {
                if (index > 0) {
                  dataOri.forEach((row, rowIndex) => {
                    if (rowIndex > 0) {
                      data.push({
                        name: row[0],
                        value: Number(row[index]),
                        lastValue: index > 1 ? Number(row[index - 1]) : 0,
                        date: date,
                        color: randomRgbColor()
                      });
                    }
                  });
                }
              });
            }
          
            // get current data and rank in descending order
            const sliceData = () =>
              dataSlice = data.filter(d => d.date === date).sort((a, b) => b.value - a.value).slice(0, count);
          
            // create scale
            const createScale = () =>
              scale = d3.scaleLinear().domain([0, d3.max(dataSlice, d => d.value)]).range([0, chartWidth]);
          
            // create axis
            const renderAxis = () => {
              createScale();
          
              axis = d3.axisTop().scale(scale).ticks(5).tickPadding(10).tickSize(0);
          
              svg.append('g')
                .classed('axis', true)
                .style('transform', `translate3d(${margin.left}px, ${margin.top}px, 0)`)
                .call(axis);
            }
          
            // create axis line
            const renderAxisLine = () => {
              d3.selectAll('g.axis g.tick').select('line.grid-line').remove();
              d3.selectAll('g.axis g.tick').append('line')
                .classed('grid-line', true)
                .attr('stroke', 'black')
                .attr('x1', 0)
                .attr('y1', 0)
                .attr('x2', 0)
                .attr('y2', chartHeight);
            }
          
            // update axis
            const updateAxis = () => {
              createScale();
          
              axis.scale().domain([0, d3.max(dataSlice, d => d.value)]);
          
              svg.select('g.axis')
                .transition().duration(duration).ease(d3.easeLinear)
                .call(axis);
          
              d3.selectAll('g.axis g.tick text').attr('font-size', 14);
            }
          
            // render date title
            const renderDateTitle = () => {
              dateTitle = svg.append('text')
                .classed('date-title', true)
                .text(date)
                .attr('x', chartWidth - margin.top)
                .attr('y', chartHeight - margin.left)
                .attr('fill', 'rgb(128, 128, 128)')
                .attr('font-size', 40)
                .attr('text-anchor', 'end')
            }
          
            const calTranslateY = (i, end) => {
              if (dateIndex === 1 || end) {
                return (barHeight + barPadding) * i + (barPadding / 2);
              } else {
                return (barHeight + barPadding) * (count + 1);
              }
            }
          
            const createChart = () => {
              chart = svg.append('g')
                .classed('chart', true)
                .style('transform', `translate3d(${margin.left}px, ${margin.top}px, 0)`);
            }
          
            const renderChart = () => {
              const bars = chart.selectAll('g.bar').data(dataSlice, (d) => d.name);
          
              let barsEnter;
          
              barsEnter = bars.enter()
                .append('g')
                .classed('bar', true)
                .style('transform', (d, i) => `translate3d(0, ${calTranslateY(i)}px, 0)`);
          
              dateIndex > 1 && barsEnter
                .transition().duration(this.duration)
                .style('transform', (d, i) => `translate3d(0, ${calTranslateY(i, 'end')}px, 0)`);
          
              barsEnter.append('rect')
                .style('width', d => scale(d.value))
                .style('height', barHeight + 'px')
                .style('fill', d => d.color);
          
              barsEnter.append('text')
                .classed('label', true)
                .text(d => d.name)
                .attr('x', '-5')
                .attr('y', barPadding)
                .attr('font-size', 14)
                .style('text-anchor', 'end');
          
              barsEnter.append('text')
                .classed('value', true)
                .text(d => d.value)
                .attr('x', d => scale(d.value) + 10)
                .attr('y', barPadding);
          
              // update
              bars.transition().duration(duration).ease(d3.easeLinear)
                .style('transform', (d, i) => 'translate3d(0, ' + calTranslateY(i, 'end') + 'px, 0)')
                .select('rect')
                .style('width', d => scale(d.value) + 'px');
          
              bars
                .select('text.value')
                .transition().duration(duration).ease(d3.easeLinear)
                .attr('x', d => scale(d.value) + 10)
                .tween('text', function (d) {
                  const textDom = this;
                  const i = d3.interpolateRound(d.lastValue, d.value);
                  return (t) => textDom.textContent = i(t);
                });
          
              // exit
              bars.exit()
                .transition().duration(duration).ease(d3.easeLinear)
                .style('transform', function (d, i) {
                  return 'translate3d(0, ' + calTranslateY(i) + 'px, 0)';
                })
                .style('width', function (d) {
                  return scale(d.value) + 'px';
                })
                .remove();
            }
          
            function createTicker() {
              const ticker = d3.interval(() => {
                if (dateIndex < dataOri[0].length - 1) {
                  dateIndex++;
                  date = getDate();
                  dateTitle.text(date);
                  sliceData();
                  updateAxis();
                  renderAxisLine();
                  renderChart();
                } else {
                  ticker.stop();
                }
              }, duration);
            }
          
            const init = () => {
              createSvg(); // create svg
              formatData(); // formatting
              sliceData(); // get current data
              renderAxis(); // render axis
              renderAxisLine(); // render axis line
              renderDateTitle(); // render date
              createChart(); // create chart
              renderChart(); // render chart
              createTicker(); // create tiker
            }
          
            init();
          
            function randomRgbColor() {
              const r = Math.floor(Math.random() * 256);
              const g = Math.floor(Math.random() * 256);
              const b = Math.floor(Math.random() * 256);
              return `rgb(${r},${g},${b})`;
            }
            
          </script>
    </section>

    <footer class="background">
        <p class="text-footer">
            Copyright ©-All rights are reserved
        </p>


    </footer>
</body>
<!--the name of the sections need to be changed-->>

</html>